<%- include("../partials/admin-header")%>

<div class="screen-overlay"></div>
<aside class="navbar-aside" id="offcanvas_aside">
    <div class="aside-top">
        <a href="adminDashboard" class="brand-wrap">
            <img src="/adminAssets/imgs/theme/logo.png" class="logo" alt="Evara Dashboard" />
        </a>
        <div>
            <button class="btn btn-icon btn-aside-minimize"><i class="text-muted material-icons md-menu_open"></i></button>
        </div>
    </div>
    <nav>
        <ul class="menu-aside">
            <li class="menu-item">
                <a class="menu-link" href="/admin/adminDashboard">
                    <i class="icon material-icons md-home"></i>
                    <span class="text">Dashboard</span>
                </a>
            </li>

            <li class="menu-item">
                <a class="menu-link" href="/admin/course-list">
                    <i class="icon material-icons md-shopping_bag"></i>
                    <span class="text">Courses</span>
                </a>
            </li>

            <li class="menu-item active">
                <a class="menu-link" href="/admin/category-list">
                    <i class="icon material-icons md-category"></i> <span class="text">Category</span>
                </a>
            </li>

            <li class="menu-item">
                <a class="menu-link" href="/admin/admin-usermanage">
                    <i class="icon material-icons md-person"></i>
                    <span class="text">Users</span>
                </a>
            </li>
            <li class="menu-item ">
                <a class="menu-link" href="/admin/order-list"> <i class="icon material-icons md-shopping_cart"></i>
                    <span class="text">Orders</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/coupon-list"> <i class="icon material-icons md-local_offer"></i>
                    <span class="text">Coupons</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/admin-creatormanage">
                    <i class="icon material-icons md-person"></i>
                    <span class="text">Creators</span>
                </a>
            </li>
            <li class="menu-item">
                <a class="menu-link" href="/admin/sales-report"> <i class="icon material-icons md-assessment"></i>
                    <span class="text">Sales Report</span>
                </a>
            </li>
        </ul>
        <hr />
        <ul class="menu-aside"></ul>
        <br />
        <br />
    </nav>
</aside>
<main class="main-wrap">
    <header class="main-header navbar">
        <div class="col-search">
            <form class="searchform">
                <div class="input-group">
                    <input list="search_terms" type="text" class="form-control" placeholder="Search term" />
                    <button class="btn btn-light bg" type="button"><i class="material-icons md-search"></i></button>
                </div>
                <datalist id="search_terms">
                    <option value="Products"></option>
                    <option value="New orders"></option>
                    <option value="Apple iphone"></option>
                    <option value="Ahmed Hassan"></option>
                </datalist>
            </form>
        </div>
        <div class="col-nav">
            <button class="btn btn-icon btn-mobile me-auto" data-trigger="#offcanvas_aside">
                <i class="material-icons md-apps"></i>
            </button>
            <ul class="nav">
                <li class="nav-item">
                    <a class="nav-link btn-icon" href="#">
                        <i class="material-icons md-notifications animation-shake"></i>
                        <span class="badge rounded-pill">3</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link btn-icon darkmode" href="#"> <i class="material-icons md-nights_stay"></i> </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="requestfullscreen nav-link btn-icon"><i class="material-icons md-cast"></i></a>
                </li>
                <li class="dropdown nav-item">
                    <a
                        class="dropdown-toggle"
                        data-bs-toggle="dropdown"
                        href="#"
                        id="dropdownLanguage"
                        aria-expanded="false"
                        ><i class="material-icons md-public"></i
                    ></a>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownLanguage">
                        <a class="dropdown-item text-brand" href="#"
                            ><img src="/adminAssets/imgs/theme/flag-us.png" alt="English" />English</a
                        >
                        <a class="dropdown-item" href="#"
                            ><img src="/adminAssets/imgs/theme/flag-fr.png" alt="Français" />Français</a
                        >
                        <a class="dropdown-item" href="#"
                            ><img src="/adminAssets/imgs/theme/flag-jp.png" alt="Français" />日本語</a
                        >
                        <a class="dropdown-item" href="#"
                            ><img src="/adminAssets/imgs/theme/flag-cn.png" alt="Français" />中国人</a
                        >
                    </div>
                </li>
                <li class="dropdown nav-item">
                    <a
                        class="dropdown-toggle"
                        data-bs-toggle="dropdown"
                        href="#"
                        id="dropdownAccount"
                        aria-expanded="false"
                    >
                        <img class="img-xs rounded-circle" src="/adminAssets/imgs/people/avatar2.jpg" alt="User"
                    /></a>
                    <div class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdownAccount">
                        <a class="dropdown-item" href="#"><i class="material-icons md-perm_identity"></i>Edit Profile</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-settings"></i>Account Settings</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-account_balance_wallet"></i>Wallet</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-receipt"></i>Billing</a>
                        <a class="dropdown-item" href="#"><i class="material-icons md-help_outline"></i>Help center</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="/admin/adminLogout"
                            ><i class="material-icons md-exit_to_app"></i>Logout</a
                        >
                    </div>
                </li>
            </ul>
        </div>
    </header>
    <section class="content-main">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title">Categories</h2>
            </div>
        </div>

        <div class="col-md-12">
            <form >
                <div class="form-group">
                    <input type="text" id="catgName" required="" name="catgName" placeholder="Category name" class="form-control" />
                </div>
                <div class="form-group">
                    <input id="catgDiscription"
                        type="text"
                        required=""
                        name="catgDiscription"
                        placeholder="Type description"
                        class="form-control"
                    />
                </div>
                <% if (typeof message !== 'undefined') { %>
                <p class="text-center" style="color: red"><%= message %></p>
                <% } %>
                <div class="form-group text-center">
                    <button type="submit" id="" class="btn btn-primary SUBMIT" name="catgsubmit">Add Category</button>
                </div>
                <div></div>
            </form>
        </div>

        <div class="col-md-12">
            <table class="table table-bordered table-lg">
                <thead>
                    <tr>
                        <th class="fs-5" style="width: 30%">Category Name</th>
                        <th class="fs-5" style="width: 50%">Description</th>
                        <th class="fs-5 text-center" style="width: 20%">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% categories.forEach(category => { %>
                    <tr>
                        <td style="width: 30%"><%= category.catgName %></td>
                        <td style="width: 50%"><%= category.catgDiscription %></td>
                        <td style="width: 20%">
                            <a href="/admin/edit-category/<%= category._id %>" class="btn btn-primary">Edit</a>
                            <!-- <a href="/admin/delete-category/<%= category._id %>" class="btn btn-primary">Delete</a> -->
                            <a href="#" class="btn btn-primary" onclick="confirmDelete('<%= category._id %>')">Delete</a>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
                
            </table>
        </div>
        
    </section>
    <!-- //swalfire -->
    <script>
        document.addEventListener("DOMContentLoaded",() => {
           const submitBtn = document.querySelector(".SUBMIT")
           submitBtn.addEventListener("click", async (event) => {
            event.preventDefault()
            const catgName = await document.getElementById("catgName").value
            const catgDiscription = await document.getElementById("catgDiscription").value
            console.log(catgName,catgDiscription);

            await fetch(`/admin/add-category`,{
                method:"POST",
                headers:{
                    'content-Type': 'application/json'
                },body:JSON.stringify({
                                        catgName,
                                        catgDiscription
                                    })
             }).then((response) =>{
                return response.json() 
            })
                .then((data)=>{
                if(data.success){
                    Swal.fire({icon: 'success',
                               title: data.message,
                               showConfirmButton: false,
                               timer: 1500
                                });
                                setTimeout(()=>{
                                    window.location.href="/admin/category-list"
                                },1500)
                                
                }else{
                    Swal.fire({icon: 'error',
                               title: data.message,
                               showConfirmButton: false,
                               timer: 1500
                                });
                }
            })
           }) 
        })
  
        
    </script>
    <!-- script of swalfire conformation while deleting -->

    <script>
        async function confirmDelete(categoryId) {
            // Display SweetAlert confirmation prompt
            Swal.fire({
                title: 'Are you sure?',
                text: 'You won\'t be able to revert this!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete it!'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    // If the user clicks "Yes", proceed with the deletion
                    try {
                        const response = await fetch(`/admin/delete-category/${categoryId}`, {
                            method: 'POST'
                        });
    
                        const data = await response.json();
    
                        if (data.success) {
                            // Successful deletion
                            Swal.fire('Deleted!', 'Your category has been deleted.', 'success');
                            // Redirect to /admin/category-list
                            setTimeout(() => {
                                window.location.href = '/admin/category-list';
                            }, 500);
                        } else {
                            // Category not found or other error
                            Swal.fire('Error!', data.error || 'An error occurred while deleting the category.', 'error');
                        }
                    } catch (error) {
                        console.error(error);
                        // Handle fetch or other errors
                        Swal.fire('Error!', 'An error occurred while processing the request.', 'error');
                    }
                }
            });
        }
         </script>
    

    <!-- script of swalfire conformation while deleting -->
 <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <footer class="main-footer font-xs"></footer>
</main>
<script src="/adminAssets/js/vendors/jquery-3.6.0.min.js"></script>
<script src="/adminAssets/js/vendors/bootstrap.bundle.min.js"></script>
<script src="/adminAssets/js/vendors/select2.min.js"></script>
<script src="/adminAssets/js/vendors/perfect-scrollbar.js"></script>
<script src="/adminAssets/js/vendors/jquery.fullscreen.min.js"></script>
<!-- Main Script -->
<script src="/adminAssets/js/main.js" type="text/javascript"></script>

<%- include("../partials/admin-footer")%>
